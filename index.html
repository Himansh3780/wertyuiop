<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Whisper | Campus Confessions</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/appwrite@14.0.1"></script>

    <style>
        body { font-family: 'Space Grotesk', sans-serif; background-color: #09090b; color: #e4e4e7; }
        .glass { background: rgba(24, 24, 27, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .input-field { background: #18181b; border: 1px solid #3f3f46; color: white; padding: 12px; border-radius: 10px; width: 100%; outline: none; }
        .input-field:focus { border-color: #818cf8; }
        .btn-primary { background: linear-gradient(135deg, #6366f1, #a855f7); color: white; font-weight: bold; padding: 12px; border-radius: 10px; width: 100%; transition: 0.3s; }
        .btn-primary:hover { opacity: 0.9; }
        .btn-google { background: white; color: black; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 10px; padding: 10px; border-radius: 50px; font-size: 14px; transition: 0.3s; cursor: pointer; }
        .btn-google:hover { background: #f4f4f5; }
    </style>
</head>
<body class="min-h-screen pb-20 flex flex-col items-center">

    <nav class="glass fixed w-full z-50 top-0 px-6 py-4 flex justify-between items-center shadow-2xl">
        <h1 class="text-2xl font-bold tracking-tighter text-indigo-400">WHISPER.</h1>
        <div id="auth-section">
            <button onclick="googleLogin()" id="login-btn" class="btn-google">
                <img src="https://cdn-icons-png.flaticon.com/512/2991/2991148.png" width="18">
                Sign in
            </button>
            <div id="user-info" class="hidden flex items-center gap-4">
                <img id="user-avatar" src="" class="w-8 h-8 rounded-full border border-indigo-500">
                <button onclick="logout()" class="text-xs text-red-400 hover:text-red-300">Logout</button>
            </div>
        </div>
    </nav>

    <main class="w-full max-w-lg mt-28 px-4 space-y-6" id="feed-container">
        <div class="text-center py-10 text-gray-600 animate-pulse text-xs tracking-widest">LOADING SECRETS...</div>
    </main>

    <button id="fab" onclick="toggleModal()" class="hidden fixed bottom-8 right-8 bg-indigo-600 hover:bg-indigo-500 text-white p-4 rounded-full shadow-2xl transition hover:scale-105 z-40">
        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
    </button>

    <div id="modal" class="fixed inset-0 bg-black/90 hidden z-[60] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="glass w-full max-w-md p-6 rounded-2xl relative">
            <button onclick="toggleModal()" class="absolute top-4 right-4 text-gray-500 hover:text-white text-xl">&times;</button>
            <h2 class="text-xl font-bold mb-4">Confess</h2>
            <textarea id="content" rows="4" class="input-field mb-4" placeholder="What's your secret?"></textarea>
            <input type="file" id="image" class="block w-full text-xs text-gray-500 mb-4 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:bg-zinc-800 file:text-indigo-400 hover:file:bg-zinc-700"/>
            <button onclick="createPost()" id="submit-btn" class="btn-primary">Post It</button>
        </div>
    </div>

    <script>
        // ---------------------------------------------------------
        // 1. FIREBASE SETUP
        // ---------------------------------------------------------
        const firebaseConfig = {
            apiKey: "AIzaSyCxNj3xODMPUWKOFFw5kORuWqc6bXTYr00",
            authDomain: "confession-wall-8ad98.firebaseapp.com",
            databaseURL: "https://confession-wall-8ad98-default-rtdb.firebaseio.com",
            projectId: "confession-wall-8ad98",
            storageBucket: "confession-wall-8ad98.firebasestorage.app",
            messagingSenderId: "932458535984",
            appId: "1:932458535984:web:0a655954fe7f5222fda1f5",
            measurementId: "G-ZWF6K9GNTZ"
        };
        
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const provider = new firebase.auth.GoogleAuthProvider();

        // ---------------------------------------------------------
        // 2. APPWRITE CONFIG (YOUR ID IS INSERTED)
        // ---------------------------------------------------------
        const APPWRITE_ENDPOINT = 'https://cloud.appwrite.io/v1';
        
        // YOUR ID ðŸ‘‡
        const APPWRITE_PROJECT = '8076463527'; 
        
        const DB_ID = 'confessions_db';
        const COL_ID = 'posts';
        const BUCKET_ID = 'images';

        const { Client, Databases, Storage, ID, Query } = Appwrite;
        const client = new Client().setEndpoint(APPWRITE_ENDPOINT).setProject(APPWRITE_PROJECT);
        const database = new Databases(client);
        const storage = new Storage(client);

        let currentUser = null;

        // --- AUTH LOGIC (Firebase) ---
        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                document.getElementById('login-btn').classList.add('hidden');
                document.getElementById('user-info').classList.remove('hidden');
                document.getElementById('user-avatar').src = user.photoURL || 'https://via.placeholder.com/40';
                document.getElementById('fab').classList.remove('hidden');
            } else {
                currentUser = null;
                document.getElementById('login-btn').classList.remove('hidden');
                document.getElementById('user-info').classList.add('hidden');
                document.getElementById('fab').classList.add('hidden');
            }
        });

        function googleLogin() {
            auth.signInWithPopup(provider).catch((error) => {
                alert("Login Failed: " + error.message);
            });
        }

        function logout() {
            auth.signOut();
            window.location.reload();
        }

        // --- DATA LOGIC (Appwrite) ---
        async function loadFeed() {
            try {
                const response = await database.listDocuments(DB_ID, COL_ID, [
                    Query.orderDesc('$createdAt'),
                    Query.limit(20)
                ]);
                
                const container = document.getElementById('feed-container');
                container.innerHTML = ''; 

                response.documents.forEach(doc => {
                    let imageHtml = doc.image_id ? `<img src="${APPWRITE_ENDPOINT}/storage/buckets/${BUCKET_ID}/files/${doc.image_id}/view?project=${APPWRITE_PROJECT}" class="w-full h-64 object-cover rounded-xl mt-3 border border-white/5 bg-zinc-900">` : '';
                    
                    container.innerHTML += `
                        <div class="glass p-6 rounded-2xl mb-6 shadow-lg border-t border-white/5">
                            <p class="text-gray-100 text-lg leading-relaxed font-light">${doc.content}</p>
                            ${imageHtml}
                            <div class="mt-4 pt-4 border-t border-white/5 flex justify-between text-xs text-gray-500 font-mono">
                                <span>${new Date(doc.$createdAt).toLocaleDateString()}</span>
                                <span class="text-pink-400">â™¥ ${doc.likes || 0}</span>
                            </div>
                        </div>`;
                });
            } catch (error) { 
                console.error("Feed Error:", error);
                document.getElementById('feed-container').innerHTML = `
                    <div class="text-red-400 text-center p-4 border border-red-900 rounded-lg">
                        <p class="font-bold">Failed to load posts.</p>
                        <p class="text-xs mt-2">1. Check if Appwrite DB Permissions are set to 'Any'.<br>2. Check if 'confessions_db' exists.</p>
                    </div>`;
            }
        }

        async function createPost() {
            if (!currentUser) return alert("Please login first!");

            const content = document.getElementById('content').value;
            const file = document.getElementById('image').files[0];
            const btn = document.getElementById('submit-btn');

            if(!content) return alert("Write something!");
            btn.innerText = "Uploading..."; btn.disabled = true;

            try {
                let imageId = null;
                if (file) {
                    const upload = await storage.createFile(BUCKET_ID, ID.unique(), file);
                    imageId = upload.$id;
                }

                await database.createDocument(DB_ID, COL_ID, ID.unique(), {
                    content: content,
                    image_id: imageId,
                    likes: 0
                });

                toggleModal();
                document.getElementById('content').value = "";
                document.getElementById('image').value = "";
                loadFeed();

            } catch (error) {
                alert("Error: " + error.message);
                console.error(error);
            }
            btn.innerText = "Post It"; btn.disabled = false;
        }

        function toggleModal() {
            const modal = document.getElementById('modal');
            modal.classList.toggle('hidden');
        }

        // Init
        loadFeed();
    </script>
</body>
</html>
