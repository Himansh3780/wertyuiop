<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CUSB Confessions</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col items-center p-4 font-sans text-gray-800">

    <header class="w-full max-w-md mb-6 text-center pt-8">
        <h1 class="text-4xl font-extrabold text-indigo-700 tracking-tight">ü§´ CUSB Confessions</h1>
        <p class="text-gray-500 text-sm mt-2 font-medium">Anonymous ‚Ä¢ Real-time ‚Ä¢ Images</p>
    </header>

    <div class="w-full max-w-md bg-white p-6 rounded-2xl shadow-xl mb-8 transform transition hover:scale-[1.01] border border-gray-100">
        <textarea id="inputText" class="w-full p-4 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent resize-none text-gray-700 bg-gray-50 placeholder-gray-400 text-lg" rows="3" placeholder="What's the secret?"></textarea>
        
        <div class="mt-4 flex items-center justify-between">
            <label class="cursor-pointer flex items-center gap-2 bg-indigo-50 px-4 py-2 rounded-lg hover:bg-indigo-100 transition text-sm text-indigo-700 font-semibold border border-indigo-100">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
                <span>Add Photo</span>
                <input type="file" id="fileInput" accept="image/*" class="hidden">
            </label>
            <span id="fileName" class="text-xs text-gray-400 truncate max-w-[150px] italic"></span>
        </div>

        <button onclick="postConfession()" id="btnPost" class="w-full mt-5 bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-bold py-3 rounded-xl hover:shadow-lg hover:from-indigo-700 hover:to-purple-700 transition active:scale-95">
            üöÄ Post Confession
        </button>
    </div>

    <div id="feed" class="w-full max-w-md space-y-6 pb-20">
        <div class="flex justify-center py-10">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
        </div>
    </div>

    <script>
        // ==========================================
        // 1. FINAL CONFIGURATION
        // ==========================================
        
        const SUPABASE_URL = "https://nxejsyiaiowhvlwbbjrr.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im54ZWpzeWlhaW93aHZsd2JianJyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgzMTI4MzMsImV4cCI6MjA4Mzg4ODgzM30.n5Hae06hNAbrcpHT3BhjGdRfJXJPdWzrO5uSJ9yNUec";
        
        const CLOUD_NAME = "dzds2gjsi"; 
        const UPLOAD_PRESET = "cusbgdfhh"; // ‚úÖ Your Preset Added Here!

        // Initialize Supabase
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // ==========================================
        // 2. IMAGE UPLOAD LOGIC
        // ==========================================
        
        // UI: Show filename when selected
        document.getElementById("fileInput").onchange = function() {
            if(this.files[0]) {
                document.getElementById("fileName").innerText = "Selected: " + this.files[0].name;
                document.getElementById("fileName").classList.add("text-indigo-500");
            }
        };

        async function uploadToCloudinary(file) {
            const formData = new FormData();
            formData.append("file", file);
            formData.append("upload_preset", UPLOAD_PRESET);

            try {
                const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, {
                    method: "POST",
                    body: formData
                });
                const data = await response.json();
                
                if (data.error) throw new Error(data.error.message);
                return data.secure_url; 
            } catch (error) {
                console.error("Cloudinary Error:", error);
                alert("Image Upload Failed: " + error.message);
                return null;
            }
        }

        // ==========================================
        // 3. POST LOGIC
        // ==========================================

        async function postConfession() {
            const textInput = document.getElementById("inputText");
            const fileInput = document.getElementById("fileInput");
            const btn = document.getElementById("btnPost");
            const text = textInput.value.trim();

            if (!text && !fileInput.files[0]) return alert("Please type something or pick a photo!");

            // Lock UI
            btn.disabled = true;
            btn.innerHTML = `<span class="animate-pulse">‚è≥ Processing...</span>`;

            let imageUrl = null;

            // Step A: Upload Image (if exists)
            if (fileInput.files[0]) {
                btn.innerHTML = `<span>üì§ Uploading Image...</span>`;
                imageUrl = await uploadToCloudinary(fileInput.files[0]);
                
                if (!imageUrl) {
                    // Reset if upload failed
                    btn.disabled = false;
                    btn.innerText = "üöÄ Post Confession";
                    return; 
                }
            }

            // Step B: Save to Supabase
            btn.innerHTML = `<span>üíæ Saving...</span>`;
            
            const { error } = await supabase
                .from('confessions')
                .insert([{ text: text, image_url: imageUrl }]); 

            if (error) {
                console.error(error);
                alert("Database Error: " + error.message);
            } else {
                // Success: Reset Form
                textInput.value = "";
                fileInput.value = "";
                document.getElementById("fileName").innerText = "";
            }
            
            // Unlock UI
            btn.disabled = false;
            btn.innerText = "üöÄ Post Confession";
        }

        // ==========================================
        // 4. FEED LOGIC (REALTIME)
        // ==========================================

        function renderFeed(posts) {
            const feed = document.getElementById("feed");
            feed.innerHTML = "";
            
            if (posts.length === 0) {
                feed.innerHTML = `
                    <div class="text-center py-10 bg-white rounded-xl shadow-sm border border-gray-100">
                        <p class="text-gray-400">No secrets here yet...</p>
                        <p class="text-indigo-500 font-semibold mt-1">Be the first to confess!</p>
                    </div>`;
                return;
            }

            posts.forEach(post => {
                const date = new Date(post.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                const safeText = post.text ? post.text.replace(/</g, "&lt;") : "";
                
                const imgHTML = post.image_url 
                    ? `<div class="mt-3 rounded-lg overflow-hidden border border-gray-100 shadow-sm">
                         <img src="${post.image_url}" class="w-full h-auto object-cover" loading="lazy">
                       </div>` 
                    : "";

                feed.innerHTML += `
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 transition hover:shadow-md">
                        <p class="text-gray-800 text-lg font-medium leading-relaxed whitespace-pre-wrap">${safeText}</p>
                        ${imgHTML}
                        <div class="flex justify-between items-center mt-4 pt-3 border-t border-gray-50">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                üïµÔ∏è Anonymous
                            </span>
                            <span class="text-xs text-gray-400 font-mono">${date}</span>
                        </div>
                    </div>
                `;
            });
        }

        async function fetchPosts() {
            let { data: posts } = await supabase
                .from('confessions')
                .select('*')
                .order('created_at', { ascending: false });
            if (posts) renderFeed(posts);
        }

        // Enable Realtime Updates
        supabase.channel('custom-all-channel')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'confessions' }, () => fetchPosts())
            .subscribe();

        // Start
        fetchPosts();
    </script>
</body>
</html>
